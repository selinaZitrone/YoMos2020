---
title: "How-To"
output: 
  html_document:
    toc: true
    includes:
      in_header: header.html
---
## Step 1: Create an empty R-package
reate a new R-project in R-Studio: File -> New Package -> New Directory

To initialize the project with a git repository click the checkmark when creating the package. Your project is initialized with a .git folder and a .gitignore

Give your package a name that is accepted as an R-package name:

- only ASCII letters, numbers and '.'
- at least two characters
- start with a letter
- not end with '.'

If you accidentally created the package without a git repository you can either use 

```r
usethis::use_git()
```
or you can initialize an empty git repository from the terminal

```sh
git init
```

## Step 2: Create your research compendium

### Fill out the DESCRIPTION  file

Fill out the fields of the description file, e.g.

```r
Package: finalPackage
Type: Package
Title: Analysis of temperature data from somewhere
Version: 0.1.0
Author: Selina Baldauf
Maintainer: Selina Baldauf <selina.baldauf@fu-berlin.de>
Description: Analysis of temperature data from our research project xyz presented in manuscript abc.
License: GPL-3
Encoding: UTF-8
LazyData: true
```

### Add a license
If you want to add a specific license to your project you can use different functions from the usethis package, e.g. for the gpl-3 license you can use

```r
usethis::use_gpl3_license(name = "Selina Baldauf")
```

This adds LICENSE.md with your name in it to the project and automatically updates the license field in the DESCRIPTION file.

### Add data to your compendium

To add data to your compendium, you can either create a /data folder and import data (e.g. as csv) or, if you want your data in .Rda format (practical because it gets automatically loaded with your package) you can do the following:

```r
# create a dummy dataset for temperature measurements
dummyTempData <- data.frame(id = 1:10, temp=rnorm(10, mean = 15, sd = 2))
usethis::use_data(dummyTempData)
```
### Write an analysis function

Write a function that you need for your analysis in the folder R/
You can group related fuctions together in the same R-script but unrelated functions get their own script.

Here, we create a simple printer function that prints the mean of a vector. We save this function in a new R-Script called myPrinterFunction.R

```r
# a simple printer function for the mean of a vector
printMean <- function(x){
  print(paste0("The mean value is ", mean(x, na.rm = T), "!"))
}
```
### Add an analysis script to your compendium

Add an analysis folder with a Rmarkdown document to your compendium.
The script can look like this: 

<pre><code>
---
title: "My analysis"
author: "Selina Baldauf"
date: "5/25/2020"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(finalPackage)
```
# This is the temperature analysis
```{r}
printMean(dummyTempData$temp)
```
</pre></code>

## Step 3: Unit testing
create the files and test folders needed by the thestthat package. Also it adds the testthat package to the Suggests field in your DESCRIPTION file.

```r
usethis::use_testthat()
```
This creates a folder /tests which contains a /testthat folder and an R-script called testthat.R. You do not need to change anything in the testthat.R script which is called by rcmdcheck to conduct all the tests that you created in your package. The folder testthat is the place to store the R-scripts with the actual tests.

You can then can initialize a basic test file for the R-script that is currently opened in R-Studio by doing

```r
usethis::use_test()
```
The testfile can be found in /tests/testthat. Testfiles have to be named test-xyz.R in order to be found.

We can write a very simple test function for our printMean function that checks if it works correctly
```r
test_that("printer function works", {
  expect_equal(printMean(c(1,2,3)), "The mean value is 2!")
})
```
If you run the test without giving any errors in the console, then it means that your test was successful.

If you want to run all the tests from your package to see if they pass your can run

```r
devtools::test()
```
## Step 4: CI with GitHub Actions

### Commit all your changes

In the `Git` tab (next to build) you can first stage all file and then commit them or you can do it from the command line:

```sh
git add *
git commit -m "initial commit"
```
### Make your compendium a Github project

For this, you can conveniently use the `usethis` package:

```r
usethis::use_github()
```
This will will initialize a GitHub repository of your compendium and will add the github url to the DESCRIPTION file. 

If you do this for the first time it is possible that you run into some issues setting up the remote repository on GitHub because you have to have the correct local git configuration.
Another possibility is to get a PAT (personal access token) for github added to your .Renviron file. You can find a step by step guide on how to do this in the [Happy Git with R book](https://happygitwithr.com/github-pat.html#github-pat).


## Add a readme to your github project

This adds a README.md to the package that will be rendered on the page of your GitHub repository in the readme section.

```r
usethis::use_readme_md()
```

## GitHub Actions

This creates the basic file structure needed to set up your workflow and automatically adds a R-CMD-check.yaml file

```r
usethis::use_github_actions()
```
If you want to use an action that already exists (e.g. from the r-lib/actions) repository you can do the following:

```r
usethis::use_github_action("render-readme.yaml")
```
This adds the respective file to ./github/workflows

# Add RStudio server with `holepunch`
There is a nice intro for holepunch: [Getting started with holepunch](https://karthik.github.io/holepunch/articles/getting_started.html).
The code below is copied'n'pasted from the [holepunch repo's readme](https://github.com/karthik/holepunch).
```r
remotes::install_github("karthik/holepunch")

write_dockerfile(maintainer = "your_name") 
# To write a Dockerfile. It will automatically pick the date of the last 
# modified file, match it to that version of R and add it here. You can 
# override this by passing r_date to some arbitrary date
# (but one for which a R version exists).

generate_badge() # This generates a badge for your readme.

# ----------------------------------------------
# At this time üôå push the code to GitHub üôå
# ----------------------------------------------

# And click on the badge or use the function below to get the build 
# ready ahead of time.
build_binder()
# ü§ûüöÄ
```

# Links and Further reading
## Ropensci's reproducibility guide 
https://ropensci.github.io/reproducibility-guide/
## Reasearch compendia
### *A guide to making your data analysis more reproducible* (by Karthik Ram)
http://inundata.org/talks/rstd19/#/
### Webinar on research compendia
https://youtu.be/g-W6fEv7Pck


## Git and GitHub
### How to use git and github with R and R-Studio
https://happygitwithr.com/
### Howto use Git branching
https://nvie.com/posts/a-successful-git-branching-model/
https://guides.github.com/introduction/flow/

### Github actions
https://help.github.com/en/actions/building-and-testing-code-with-continuous-integration/about-continuous-integration
https://www.youtube.com/watch?v=F3wZTDmHCFA

### CI with github actions

* Jim Hester on [GitHub Actions with R](https://rstudio.com/resources/rstudioconf-2020/azure-pipelines-and-github-actions/)
* [Getting started](https://help.github.com/en/actions/getting-started-with-github-actions) with GitHub Actions
* [Examples](https://github.com/r-lib/actions) for Actions with R

### Jim Hester (tidy developer) on how to use R with github actions, what is the difference between github actions, Travis CI and others, how to set up different workflows:
https://resources.rstudio.com/rstudio-conf-2020/azure-pipelines-and-github-actions-jim-hester

### How to use an .Rmd document as Readme in github and render it automatically with associated figures on push:
https://www.r-bloggers.com/rendering-your-readme-with-github-actions/
https://www.edwardthomson.com/blog/github_actions_advent_calendar.html

## Unit testing

* [Intro to unit testing in R](https://katherinemwood.github.io/post/testthat/)
* Testing with [<code>testthat</code>](http://r-pkgs.had.co.nz/tests.html)

## Holepunch package for R and Binder
https://karthik.github.io/holepunch/


## Scientific publications
James, Justin. 2012. ‚Äú10 Classic Mistakes That Plague Software Development Projects.‚Äù 2012. https://www.techrepublic.com/blog/10-things/10-classic-mistakes-that-plague-software-development-projects/.

Scheller, Robert M, Brian R Sturtevant, Eric J Gustafson, Brendan C Ward, and David J Mladenoff. 2010. ‚ÄúIncreasing the Reliability of Ecological Models Using Modern Software Engineering Techniques.‚Äù Frontiers in Ecology and the Environment 8 (5): 253‚Äì60. https://doi.org/10.1890/080141.

Baxter, Susan M., Steven W. Day, Jacquelyn S. Fetrow, and Stephanie J. Reisinger. 2006. ‚ÄúScientific Software Development Is Not an Oxymoron.‚Äù PLoS Computational Biology 2 (9): 0975‚Äì78. https://doi.org/10.1371/journal.pcbi.0020087.

Merali, Zeeya. 2010. ‚ÄúComputational Science: ...Error.‚Äù Nature 467 (7317): 775‚Äì77. https://doi.org/10.1038/467775a.

Passig, Kathrin, and Johannes Jander. 2013. Weniger Schlecht Programmieren. O‚ÄôReilly.

Storer, Tim. 2017. ‚ÄúBridging the Chasm: A Survey of Software Engineering Practice in Scientific Programming.‚Äù ACM Computing Surveys 50 (4). https://doi.org/10.1145/3084225.

Marwick, Ben, Carl Boettiger, and Lincoln Mullen. 2018. ‚ÄúPackaging Data Analytical Work Reproducibly Using R (and Friends).‚Äù American Statistician 72 (1): 80‚Äì88. https://doi.org/10.1080/00031305.2017.1375986.
